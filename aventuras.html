<!DOCTYPE html>
<html lang="pt_br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aventuras Incríveis</title>
    <link rel="stylesheet" href="aventuras incriveis.css">
</head>
<body>
<div id="background-image"></div>
<div id="botao-cura">
    <button id="botao-curar">!!CURAR!!</button>
</div>
<div id="top-bar" style="font-size: 50px;">
    <span id="life">Vida: 100</span>
</div>
<table id="grid" width="800" height="700px" border="0" cellpadding="0" cellspacing="0" align="center">

</table>


<script>

    function showNextParagraph() {
        const storyParagraphs = [
            "Seu unico item e uma pequena adaga enferrujada...",
            "Sua melhor esperanca agora e explorar essa floresta desconhecida",
        ];

        const storyParagraph = document.getElementById("story-paragraph");
        const nextButton = document.getElementById("next-button");
        if (!storyParagraph || !nextButton) return;

        let currentIndex = parseInt(storyParagraph.dataset.index) || 0;

        if (currentIndex < storyParagraphs.length) {
            storyParagraph.textContent = storyParagraphs[currentIndex];
            currentIndex++;
            storyParagraph.dataset.index = currentIndex;
            if (currentIndex === storyParagraphs.length) {
                nextButton.textContent = "...";
                nextButton.disabled = true;
            }
        }
    }

    const storyParagraph = document.getElementById("story-paragraph");
    const storyText = "Você acorda sozinho em um lugar desconhecido..."; // Texto da história
    let index = 0;

    function typeWriter() {
        if (index < storyText.length) {
            storyParagraph.innerHTML += storyText.charAt(index);
            index++;
            setTimeout(typeWriter, 50); // Agendando a próxima chamada para 50 milissegundos depois
        }
    }
    setTimeout(typeWriter, 1000); 
    window.onload = function () {
        typeWriter();
    };

    document.addEventListener("DOMContentLoaded", function () {
        const nextButton = document.getElementById("next-button");
        if (!nextButton) return;

        nextButton.addEventListener("click", function () {
            showNextParagraph();
        });
        atualizarVisibilidadeMapa();
    });
    class Item {
        constructor(name, imageSrc) {
            this.name = name;
            this.imageSrc = imageSrc;
        }
    }

    let playerDano = 0;
    let playerX = 9;
    let playerY = 11;
    let life = 100;
    let inventory = [];
    let itemsOnMap = [];
    let monstrosOnMap = [];
    let isPlayerInCombat = false;
    const barriers = [];


    function removeFromInventory(itemName, arr) {
        const index = arr.findIndex(item => item.name === itemName);
        if (index !== -1) {
            arr.splice(index, 1);
        }
    }

    function hasItemInInventory(itemName) {
        return inventory.some(item => item.name === itemName);
    }

    function verificarEspada() {
        const espadaIndex = inventory.findIndex(item => item.name === "Espada");
        if (espadaIndex !== -1) {
            playerDano += 60;
            showAlert("Você pegou a espada e adquiriu +60 de dano!");
        }
    }

    function addToInventory(item) {
        inventory.push(item);
        updateInventory();
        const inventoryList = document.getElementById("items");
        const itemElement = document.createElement("li");
        itemElement.textContent = item.name;
        inventoryList.appendChild(itemElement);
    }

    function criarParedeVertical(inicioX, inicioY, finalX) {
        for (let x = inicioX; x <= finalX; x++) {
            const coordenada = { x, y: inicioY };
            barriers.push(coordenada);
        }
    }

    function criarParedeHorizontal(inicioX, inicioY, finalY) {
            for (let y = inicioY; y <= finalY; y++) {
                const coordenada = { x: inicioX, y };
                barriers.push(coordenada);
            }
    }

    function realizarAtaqueMonstro() {
        if (isPlayerInCombat) {
            const monstroIndex = monstrosOnMap.findIndex(monstroObj =>
                Math.abs(monstroObj.x - playerX) <= 1 && Math.abs(monstroObj.y - playerY) <= 1
            );
    
            if (monstroIndex !== -1) {
                const monstro = monstrosOnMap[monstroIndex].monstro;
                const resultadoDadoMonstro = girarDado(20);
                const danoCausadoMonstro = resultadoDadoMonstro * monstro.dano;
                life -= danoCausadoMonstro;
    
                if (life <= 0) {
                    showAlert("Você morreu! Fim de jogo.");
                    showAlert("Reiniciando em 5 segundos");
                    reiniciarPagina();
                } else {
                    showAlert(`O ${monstro.name} atacou você! Causou ${danoCausadoMonstro} de dano.`);
                    showAlert(`Vida restante: ${life}`);
                    atualizarVida();
                }
            }
        }
    }

    function updateBackgroundSize() {
        const background = document.getElementById("background-image");
        const newSize = `${window.innerWidth * 4}px ${window.innerHeight * 4}px`;
        background.style.backgroundSize = newSize;
    }

    function addItemToMap(name, imageSrc, x, y) {
        const item = new Item(name, imageSrc);
        itemsOnMap.push({ item, x, y });
        updateTable();
    }

    function addMonstroToMap(name, imageSrc, dano, vida, x, y) {
        const monstro = { name, imageSrc, dano, vida };
        monstrosOnMap.push({ monstro, x, y });
        updateTable();
    }

    function iniciarCombate() {
        if (isPlayerInCombat) {
            showAlert("Você já está em combate!");
            document.getElementById("botao-girar-dado").disabled = false;
            return;
        }

        const monstroProximo = monstrosOnMap.find(monstroObj =>
            Math.abs(monstroObj.x - playerX) <= 0.5 && Math.abs(monstroObj.y - playerY) <= 0.5
        );

        if (monstroProximo) {
            isPlayerInCombat = true;
            showAlert("Você entrou em modo de combate!");
            document.getElementById("botao-girar-dado").disabled = false;
            document.getElementById("combate-container").style.display = "block";
        }
    }

    function terminarCombate() {
        isPlayerInCombat = false;
        document.getElementById("botao-girar-dado").disabled = true;
        showAlert("Você saiu do modo de combate.");
        document.getElementById("combate-container").style.display = "none";
    }

    function realizarAtaque() {
        if (!isPlayerInCombat) {
            showAlert("Você não está em combate!");
            return;
        }

        const resultadoDado = girarDado(20);
        const danoCausado = resultadoDado * (playerDano + 10); // 10 de dano base
        const monstroIndex = monstrosOnMap.findIndex(monstroObj =>
            Math.abs(monstroObj.x - playerX) <= 1 && Math.abs(monstroObj.y - playerY) <= 1
        );

        if (monstroIndex !== -1) {
            const monstro = monstrosOnMap[monstroIndex].monstro;
            monstro.vida -= danoCausado;

            if (monstro.vida <= 0) {
                showAlert("Você derrotou o monstro!");
                monstrosOnMap.splice(monstroIndex, 1);
                terminarCombate();
            } else {
                showAlert(`Você causou ${danoCausado} de dano ao ${monstro.name}.`);
                showAlert(`Vida restante: ${monstro.vida}`);
                atualizarVida();
            }
        }
    }

    function girarDado(lados) {
        return Math.floor(Math.random() * lados) + 1;
    }

    function updateTable() {
        const numRows = 18;
        const numCols = 30;
        const cellSize = 40;
        const table = document.querySelector("table");
        table.innerHTML = '';

        const totalWidth = numCols * cellSize;
        const totalHeight = numRows * cellSize;

        const offsetX = (window.innerWidth - totalWidth) / 2;
        const offsetY = (window.innerHeight - totalHeight) / 2;


        for (let i = 0; i < numRows; i++) {
            const row = document.createElement("tr");
            for (let j = 0; j < numCols; j++) {
                const cell = document.createElement("td");
                cell.id = `cell${i}${j}`;
                cell.style.width = `${cellSize}px`;
                cell.style.height = `${cellSize}px`;

                const itemOnCellIndex = itemsOnMap.findIndex(item => item.x === i && item.y === j);
                if (itemOnCellIndex !== -1) {
                    const itemOnCell = itemsOnMap[itemOnCellIndex];
                    const itemImage = document.createElement('img');
                    itemImage.src = itemOnCell.item.imageSrc;
                    itemImage.classList.add('Gif_Img');
                    cell.appendChild(itemImage);
                }

                const monstroOnCell = monstrosOnMap.find(monstroObj => monstroObj.x === i && monstroObj.y === j);
                if (monstroOnCell) {
                    const monstroImage = document.createElement('img');
                    monstroImage.src = monstroOnCell.monstro.imageSrc;
                    monstroImage.classList.add('Gif_Img');

                    cell.appendChild(monstroImage);
                }


                row.appendChild(cell);
            }
            table.appendChild(row);
        }

        table.style.position = 'absolute';
        table.style.left = `${offsetX}px`;
        table.style.top = `${offsetY}px`;

        const playerCell = document.getElementById(`cell${playerX}${playerY}`);
        const playerImage = document.createElement('img');
        playerImage.src = "imgs/pixil-frame-0.png";
        playerImage.width = 50;
        playerImage.height = 50;
        playerCell.appendChild(playerImage);

        atualizarVida(); 
    }

    function isBarrier(x, y) {
        return barriers.some(coordenada => coordenada.x === x && coordenada.y === y);
    }

    function movePlayer(event) {
        if (isPlayerInCombat) {
            showAlert("Você está em combate! Gire o dado para atacar.");
            return;
        }
        updateBackgroundSize();
        let newPlayerX = playerX;
        let newPlayerY = playerY;
        updateCameraPosition();
    
        switch (event.key) {
            case "ArrowUp":
                if (playerX > 0 && !isBarrier(playerX - 1, playerY)) {
                    newPlayerX--;
                    updateInventory();
                }
                break;
            case "ArrowDown":
                if (playerX < 17 && !isBarrier(playerX + 1, playerY)) { 
                    newPlayerX++;
                    updateInventory();
                }
                break;
            case "ArrowLeft":
                if (playerY > 0 && !isBarrier(playerX, playerY - 1)) {
                    newPlayerY--;
                    updateInventory();
                }
                break;
            case "ArrowRight":
                if (playerY < 29 && !isBarrier(playerX, playerY + 1)) { 
                    newPlayerY++;
                    updateInventory();
                }
                break;
        }
    
        const espadaIndex = itemsOnMap.findIndex(item => item.x === newPlayerX && item.y === newPlayerY && item.item.name === "Espada");
        if (espadaIndex !== -1) {
            itemsOnMap.splice(espadaIndex, 1);
            playerDano += 60;
            showAlert("Você pegou a espada e adquiriu +60 de dano!");
            updateInventory();
        }
    
        const itemIndex = itemsOnMap.findIndex(item => item.x === newPlayerX && item.y === newPlayerY);
        if (itemIndex !== -1) {
            const pickedItem = itemsOnMap.splice(itemIndex, 1)[0];
            addToInventory(pickedItem.item);
        }
    
        if (!isBarrier(newPlayerX, newPlayerY)) {
            playerX = newPlayerX;
            playerY = newPlayerY;
            updateTable();
        }
        atualizarVisibilidadeMapa();
        atualizarVida();
        iniciarCombate();
    }
    

    function atualizarResultadoDado(resultado) {
        const resultadoDadoElement = document.getElementById("resultado-dado");
        resultadoDadoElement.textContent = `Resultado do Dado: ${resultado}`;
    }

    function atualizarVida() {
        document.getElementById("life").textContent = `Vida: ${life}`;
    }

    function updateInventory() {
        const hasPotion = hasItemInInventory("Poção");
        const botaoCurar = document.getElementById("botao-curar");
        if (hasPotion) {
            botaoCurar.style.display = "block";
        } else {
            botaoCurar.style.display = "none"; 
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("botao-girar-dado").addEventListener("click", function () {
            if (isPlayerInCombat) {
                const resultadoDado = girarDado(20);
                atualizarResultadoDado(resultadoDado);
                realizarAtaque();
                realizarAtaqueMonstro();
            }
        });
    });

    document.getElementById("botao-curar").addEventListener("click", function () {
        if (hasItemInInventory("Poção")) {
            removeFromInventory("Poção", inventory);
            life += 30; // Aumenta a vida em 30 ao usar a poção
            atualizarVida(); // Atualiza a vida do jogador na div 'life'
            updateInventory();
            showAlert("Você usou uma Poção e recuperou 30 de vida!");
        }
    });

    function updateCameraPosition() {
        const background = document.getElementById("background-image");
        const offsetX = Math.max(0, Math.min((playerY - 5) * -40, (30 - 10) * -40)); 
        const offsetY = Math.max(0, Math.min((playerX - 5) * -40, (18 - 10) * -40)); 
        background.style.backgroundPosition = `${offsetX}px ${offsetY}px`;
    }
    

    addItemToMap("Poção", "imgs/abacate.png", 9, 4);
    addItemToMap("Poção", "imgs/abacate.png", 9, 5);
    addItemToMap("Espada", "imgs/SPADA.png", 6, 3);
    addMonstroToMap("alien", "imgs/boss.png", 8, 900, 2, 16);
    addMonstroToMap("Monstro do Lago", "imgs/agua.png", 70, 850, 2, 8);
    addMonstroToMap("arvore", "imgs/dinosario.png", 5, 900, 4, 10);
    addMonstroToMap("caveira", "imgs/cavera.png", 5, 1000, 17, 19);

    document.addEventListener("keydown", function(event) {
        movePlayer(event);
        
    })

    function showAlert(message) {
        const alertBox = document.getElementById("result-alert");
        const newAlert = document.createElement("div");
        newAlert.textContent = message;
        alertBox.appendChild(newAlert);
    }

    function reiniciarPagina() {
        setTimeout(function() {
            location.reload();
        }, 5000); 
    }

    function limparDiv() {
        var div = document.getElementById('result-alert');
        div.innerHTML = '';
    }

    document.addEventListener("DOMContentLoaded", function () {
        var botao = document.getElementById('botaoLimpar');
        botao.addEventListener("click", limparDiv);
    });

    var botao = document.getElementById('botaoLimpar');
    botao.onclick = limparDiv;

    function atualizarVisibilidadeMapa() {
        const alcanceVisual = 1.4; // Defina o alcance visual do personagem
        const numRows = 18;
        const numCols = 30;
    
        for (let i = 0; i < numRows; i++) {
            for (let j = 0; j < numCols; j++) {
                const cell = document.getElementById(`cell${i}${j}`);
                const distancia = Math.abs(playerX - i) + Math.abs(playerY - j);
    
                if (distancia > alcanceVisual) {
                    cell.style.visibility = "hidden"; 
    
                    
                    const fogElement = document.createElement('div');
                    fogElement.classList.add('fog');
                    cell.appendChild(fogElement);
                } else {
                    cell.style.visibility = "visible";
    
                    // Remove a névoa da célula se estiver dentro do alcance visual
                    const fogElement = cell.querySelector('.fog');
                    if (fogElement) {
                        cell.removeChild(fogElement);
                    }
                }
            }
        }
    }


</script>

<div id="inventario">
    <h2>Inventário</h2>
    <ul id="items"></ul>
</div>

<div id="combate-box">
    <p>Modo de Combate</p>
    <p id="resultado-dado">Resultado do Dado: 0</p>
    <button id="botao-girar-dado" disabled>Girar Dado</button>
</div>


<div id="alert-container">
    <p>Relatório de Combate</p>
    <button id="botaoLimpar">Limpar Div</button>
    <p id="result-alert"></p>
</div>

<div id="story-container">
    <div id="story-box">
        <p id="story-paragraph">Voce acorda sozinho em um lugar desconhecido.</p>
        <button id="next-button">Próximo</button>
    </div>

</body>
</html>